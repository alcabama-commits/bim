<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Planos Proyecto Blue - Portal BIM Alcabama</title>

  <!-- Tailwind CDN (solo para desarrollo) -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Configuraci√≥n de Tailwind -->
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#D8005E",
            "background-light": "#FFFFFF",
            "background-dark": "#343434",
            "text-light": "#111827",
            "text-dark": "#F3F4F6",
            "card-light": "#FFFFFF",
            "card-dark": "#374151",
            "border-light": "#E5E7EB",
            "border-dark": "#4B5563"
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            'source-sans-pro': ['"Source Sans Pro"', 'sans-serif']
          },
          borderRadius: { DEFAULT: "0.5rem" },
        },
      },
    };
  </script>

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    #viewer-container {
      position: relative;
      width: 100%;
      height: 70vh;
      min-height: 400px;
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark">

  <!-- ENCABEZADO -->
  <header class="absolute top-0 left-0 w-full z-10 px-8 py-4">
    <div class="container mx-auto flex items-center justify-between">
      <div class="flex items-center">
        <a href="home.html" aria-label="Volver a la p√°gina de inicio">
          <img alt="Portal BIM Alcabama Logo" class="h-12 dark:hidden" src="https://i.postimg.cc/wMDNvJB5/Portal-BIM-Alcabama-7-1.png"/>
          <img alt="Portal BIM Alcabama Logo" class="h-12 hidden dark:block" src="https://i.postimg.cc/mgpPTVwf/Portal-BIM-Alcabama-7-2.png"/>
        </a>
      </div>
      <div class="flex items-center space-x-4">
        <button id="theme-toggle" aria-label="Cambiar tema" class="text-text-light dark:text-white hover:text-primary">
          <span class="material-symbols-outlined">dark_mode</span>
        </button>
        <div id="auth-container" class="flex items-center space-x-4">
          <a href="inse.html" class="text-text-light dark:text-white hover:text-primary text-sm font-medium">Iniciar sesi√≥n</a>
        </div>
      </div>
    </div>
  </header>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="pt-24 pb-16">
    <section class="container mx-auto px-8 py-8">
      <h1 class="text-3xl font-bold text-center mb-8">Planos y Modelos del Proyecto Blue</h1>

      <div class="relative rounded-lg shadow-lg overflow-hidden bg-gray-200 dark:bg-gray-700">
        <div id="loading-indicator" class="absolute inset-0 flex items-center justify-center text-gray-500 z-10">
          <p>Cargando modelo 3D...</p>
        </div>
        <div id="viewer-container"></div>
      </div>

      <p class="text-center text-gray-600 dark:text-gray-400 mt-4">
        Usa el rat√≥n para navegar en el modelo 3D. Rueda para zoom, clic derecho para rotar, clic izquierdo para seleccionar.
      </p>
    </section>
  </main>

  <!-- PIE DE P√ÅGINA -->
  <footer class="bg-background-light dark:bg-background-dark py-8 px-8 mt-auto">
    <div class="container mx-auto text-center text-gray-500 dark:text-gray-400">
      <img alt="Alcabama logo" class="h-8 mx-auto mb-4 dark:hidden" src="https://i.postimg.cc/GmWLmfZZ/Logo-transparente-negro.png"/>
      <img alt="Alcabama logo" class="h-8 mx-auto mb-4 hidden dark:block" src="https://i.postimg.cc/0yDgcyBp/Logo-transparente-blanco.png"/>
      <p class="text-sm">¬© 2023 Portal BIM Alcabama - Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- SCRIPT PRINCIPAL -->
  <script type="module">
    document.addEventListener('DOMContentLoaded', async () => {

      // =========================
      // GESTI√ìN DE AUTENTICACI√ìN
      // =========================
      const authContainer = document.getElementById('auth-container');
      const userAccount = JSON.parse(sessionStorage.getItem('userAccount') || localStorage.getItem('userAccount'));

      if (userAccount) {
        authContainer.innerHTML = `
          <span class="text-sm font-medium text-text-light dark:text-white">Hola, ${userAccount.name.split(' ')[0]}</span>
          <button id="logout-button" class="text-text-light dark:text-white hover:text-primary text-sm font-medium">Cerrar sesi√≥n</button>
        `;
        document.getElementById('logout-button').addEventListener('click', () => {
          sessionStorage.removeItem('userAccount');
          localStorage.removeItem('userAccount');
          window.location.href = 'home.html';
        });
      }

      // =====================
      // GESTI√ìN DEL TEMA (DARK/LIGHT)
      // =====================
      const themeToggle = document.getElementById('theme-toggle');
      const htmlEl = document.documentElement;

      const applyTheme = (theme) => {
        if (theme === 'dark') {
          htmlEl.classList.add('dark');
          themeToggle.querySelector('.material-symbols-outlined').textContent = 'light_mode';
        } else {
          htmlEl.classList.remove('dark');
          themeToggle.querySelector('.material-symbols-outlined').textContent = 'dark_mode';
        }
      };

      const savedTheme = localStorage.getItem('theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      applyTheme(savedTheme);

      themeToggle.addEventListener('click', () => {
        const newTheme = htmlEl.classList.contains('dark') ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
      });

      // =====================
      // VISOR IFC
      // =====================
      const container = document.getElementById('viewer-container');
      const loadingIndicator = document.getElementById('loading-indicator');
      let IfcViewerAPI, viewer;

      try {
        console.log("üåê Intentando cargar visor desde CDN...");
        const module = await import("https://unpkg.com/web-ifc-viewer@1.0.220/dist/web-ifc-viewer.es.js");
        IfcViewerAPI = module.IfcViewerAPI;
        console.log("‚úÖ CDN cargado correctamente");
      } catch (error) {
        console.warn("‚ö†Ô∏è Error con el CDN, usando librer√≠as locales:", error);
        const module = await import("./libs/web-ifc-viewer.es.js");
        IfcViewerAPI = module.IfcViewerAPI || module.default;
      }

      // Inicializa el visor
      viewer = new IfcViewerAPI({
        container,
        backgroundColor: new Uint8Array([255, 255, 255])
      });

      viewer.grid.setGrid();
      viewer.axes.setAxes();

      // Carga el modelo IFC
      const ifcUrl = "./models/02_GI_BLU_Estructura_CBombas2.ifc";
      try {
        await viewer.IFC.loadIfcUrl(ifcUrl);
        loadingIndicator.style.display = 'none';
        viewer.context.fitToFrame();
        console.log("üèóÔ∏è Modelo IFC cargado correctamente");
      } catch (e3) {
        console.error("‚ùå Error cargando el modelo IFC:", e3);
        loadingIndicator.innerHTML = `
          <div class="text-red-500 text-center p-6 max-w-md mx-auto">
            <p class="font-bold text-lg">Error al cargar el modelo</p>
            <p class="text-sm mt-2">${e3.message}</p>
            <p class="text-xs mt-3 text-gray-600 dark:text-gray-400">
              Aseg√∫rate de que el archivo IFC est√© en la carpeta /models y tenga permisos de lectura.
            </p>
          </div>
        `;
      }

    });
  </script>

</body>
</html>
