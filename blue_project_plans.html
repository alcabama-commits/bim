<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Planos Proyecto Blue - Portal BIM Alcabama</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#D8005E",
          "background-light": "#FFFFFF",
          "background-dark": "#343434",
          "text-light": "#111827",
          "text-dark": "#F3F4F6",
          "card-light": "#FFFFFF",
          "card-dark": "#374151",
          "border-light": "#E5E7EB",
          "border-dark": "#4B5563"
        },
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
          'source-sans-pro': ['"Source Sans Pro"', 'sans-serif']
        },
        borderRadius: { DEFAULT: "0.5rem" },
      },
    },
  };
</script>

<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>

<style>
  body { font-family: 'Inter', sans-serif; }
  .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
  #viewer-container { position: relative; width: 100%; height: 70vh; min-height: 500px; }
</style>
</head>

<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark">

<div class="relative min-h-screen bg-background-light dark:bg-background-dark">
<header class="absolute top-0 left-0 w-full z-10 px-8 py-4">
  <div class="container mx-auto flex items-center justify-between">
    <div class="flex items-center">
      <a href="home.html" aria-label="Volver a la página de inicio">
        <img alt="Portal BIM Alcabama Logo" class="h-12 dark:hidden" src="https://i.postimg.cc/wMDNvJB5/Portal-BIM-Alcabama-7-1.png"/>
        <img alt="Portal BIM Alcabama Logo" class="h-12 hidden dark:block" src="https://i.postimg.cc/mgpPTVwf/Portal-BIM-Alcabama-7-2.png"/>
      </a>
    </div>
    <div class="flex items-center space-x-4">
      <button id="theme-toggle" aria-label="Cambiar tema" class="text-text-light dark:text-white hover:text-primary">
        <span class="material-symbols-outlined">dark_mode</span>
      </button>
      <div id="auth-container" class="flex items-center space-x-4">
        <a href="inse.html" class="text-text-light dark:text-white hover:text-primary text-sm font-medium">Iniciar sesión</a>
      </div>
    </div>
  </div>
</header>

<main class="pt-24 pb-16">
    <section class="container mx-auto px-8 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">Planos y Modelos del Proyecto Blue</h1>
        <p class="text-center text-gray-600 dark:text-gray-400 max-w-3xl mx-auto mb-6">
          Modelo cargado desde el repositorio. Usa los botones para interactuar o sube tu propio archivo. 
          Navega en el modelo 3D con el ratón: rueda para zoom, clic derecho para rotar.
        </p>

        <!-- Controles -->
        <div class="flex justify-center items-center space-x-4 mb-6">
            <button id="fit-button" disabled class="px-4 py-2 bg-primary text-white rounded-md shadow-md hover:bg-opacity-90 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
              Enfocar Modelo
            </button>
            <button id="load-repo" class="px-4 py-2 bg-gray-600 text-white rounded-md shadow-md hover:bg-gray-700 transition">
              Recargar Modelo
            </button>
        </div>

        <!-- Carga local -->
        <div class="text-center mb-8">
            <label for="file-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">O sube tu propio archivo .ifc</label>
            <input type="file" id="file-input" accept=".ifc" class="mx-auto block w-full max-w-sm text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer"/>
        </div>

        <!-- Visor -->
        <div id="viewer-container" class="relative rounded-lg shadow-lg overflow-hidden bg-white dark:bg-gray-800">
            <div class="loading absolute inset-0 flex items-center justify-center z-10 bg-white/80 dark:bg-gray-800/80">
                <p class="text-lg font-semibold text-primary">Cargando modelo desde GitHub...</p>
            </div>
        </div>
        <div class="info text-center mt-4 font-semibold" id="info"></div>
    </section>
</main>

<footer class="bg-background-light dark:bg-background-dark py-8 px-8 mt-auto">
  <div class="container mx-auto text-center text-gray-500 dark:text-gray-400">
    <img alt="Alcabama logo" class="h-8 mx-auto mb-4 dark:hidden" src="https://i.postimg.cc/GmWLmfZZ/Logo-transparente-negro.png"/>
    <img alt="Alcabama logo" class="h-8 mx-auto mb-4 hidden dark:block" src="https://i.postimg.cc/0yDgcyBp/Logo-transparente-blanco.png"/>
    <p class="text-sm">© 2025 Portal BIM Alcabama - Todos los derechos reservados.</p>
  </div>
</footer>
</div>

<!-- Importmap -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    const { IfcAPI } = await import('https://cdn.jsdelivr.net/npm/web-ifc@0.0.51/web-ifc-api.js');

    document.addEventListener('DOMContentLoaded', () => {
        // --- TEMA Y AUTH ---
        const authContainer = document.getElementById("auth-container");
        const userAccount = JSON.parse(sessionStorage.getItem("userAccount") || localStorage.getItem("userAccount"));

        if (userAccount) {
            authContainer.innerHTML = `
                <span class="text-sm font-medium text-text-light dark:text-white">Hola, ${userAccount.name.split(" ")[0]}</span>
                <button id="logout-button" class="text-text-light dark:text-white hover:text-primary text-sm font-medium">Cerrar sesión</button>
            `;
            document.getElementById("logout-button").addEventListener("click", () => {
                sessionStorage.removeItem("userAccount");
                localStorage.removeItem("userAccount");
                window.location.href = "home.html";
            });
        }

        const themeToggle = document.getElementById("theme-toggle");
        const htmlEl = document.documentElement;
        let currentTheme = localStorage.getItem("theme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

        const applyTheme = (theme) => {
            if (theme === "dark") {
                htmlEl.classList.add("dark");
                themeToggle.querySelector(".material-symbols-outlined").textContent = "light_mode";
            } else {
                htmlEl.classList.remove("dark");
                themeToggle.querySelector(".material-symbols-outlined").textContent = "dark_mode";
            }
            currentTheme = theme;
            if (window.viewer) window.viewer.updateTheme(currentTheme);
        };

        applyTheme(currentTheme);
        themeToggle.addEventListener("click", () => {
            const newTheme = htmlEl.classList.contains("dark") ? "light" : "dark";
            localStorage.setItem("theme", newTheme);
            applyTheme(newTheme);
        });

        // --- VISOR IFC ---
        const container = document.getElementById('viewer-container');
        const input = document.getElementById('file-input');
        const loadingContainer = container.querySelector('.loading');
        const info = document.getElementById('info');
        const fitButton = document.getElementById('fit-button');
        const repoButton = document.getElementById('load-repo');

        // URL CORRECTA: raw.githubusercontent.com
        const REPO_MODEL_URL = 'https://raw.githubusercontent.com/alcabama-commits/bim/main/Models/02_GI_BLU_Estructura_CBombas2.ifc';

        const viewer = new class {
            constructor() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 2000);
                this.camera.position.set(50, 50, 50);
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(container.clientWidth, container.clientHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                container.appendChild(this.renderer.domElement);

                this.updateTheme(currentTheme);

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                this.scene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
                directionalLight.position.set(100, 100, 50);
                this.scene.add(directionalLight);

                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;

                const animate = () => {
                    requestAnimationFrame(animate);
                    this.controls.update();
                    this.renderer.render(this.scene, this.camera);
                };
                animate();

                this.ifc = new IfcAPI();
                this.ifc.SetWasmPath('https://cdn.jsdelivr.net/npm/web-ifc@0.0.51/');

                this.grid = new THREE.GridHelper(200, 50);
                this.scene.add(this.grid);
                this.axes = new THREE.AxesHelper(10);
                this.scene.add(this.axes);

                this.models = [];
                this.currentMesh = null;

                window.addEventListener('resize', () => this.onResize());
            }

            updateTheme(theme) {
                const isDark = theme === 'dark';
                this.scene.background = new THREE.Color(isDark ? 0x343434 : 0xf0f4ff);
                if (this.grid) this.grid.material.color.set(isDark ? 0x4B5563 : 0xcccccc);
            }

            onResize() {
                this.camera.aspect = container.clientWidth / container.clientHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(container.clientWidth, container.clientHeight);
            }

            async load(url) {
                info.textContent = '';
                loadingContainer.style.display = 'flex';
                loadingContainer.querySelector('p').textContent = 'Cargando modelo...';
                fitButton.disabled = true;
                repoButton.disabled = true;
                input.disabled = true;

                this.models.forEach(m => this.scene.remove(m));
                this.models = [];
                this.currentMesh = null;

                try {
                    await this.ifc.Init();
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Error HTTP ${response.status}`);
                    const buffer = await response.arrayBuffer();
                    const modelID = this.ifc.OpenModel(new Uint8Array(buffer), {
                        COORDINATE_TO_ORIGIN: true,
                        USE_FAST_BOOLS: true
                    });

                    const allIfcItems = Object.values(this.ifc).filter(v => typeof v === 'number' && v > 1000);
                    let totalVerts = 0;
                    const positions = [], indices = [];

                    for (const type of allIfcItems) {
                        const ids = this.ifc.GetLineIDsWithType(modelID, type);
                        for (let i = 0; i < ids.size(); i++) {
                            const id = ids.get(i);
                            const geom = this.ifc.GetGeometry(modelID, id);
                            if (!geom) continue;

                            const verts = geom.GetVertexData();
                            const inds = geom.GetIndexData();
                            const base = positions.length / 3;

                            for (let j = 0; j < verts.length; j += 3) {
                                positions.push(verts[j], verts[j + 1], verts[j + 2]);
                            }
                            for (let j = 0; j < inds.length; j++) {
                                indices.push(inds[j] + base);
                            }
                            totalVerts += verts.length / 3;
                        }
                    }

                    if (totalVerts === 0) throw new Error('No se encontró geometría 3D');

                    const geometry = new THREE.BufferGeometry();
                    geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                    geometry.setIndex(indices);
                    geometry.computeVertexNormals();

                    const material = new THREE.MeshLambertMaterial({
                        color: 0x99aaff,
                        side: THREE.DoubleSide,
                        transparent: true,
                        opacity: 0.95
                    });

                    const mesh = new THREE.Mesh(geometry, material);
                    this.scene.add(mesh);
                    this.models.push(mesh);
                    this.currentMesh = mesh;

                    loadingContainer.style.display = 'none';
                    info.textContent = `Modelo cargado: ${totalVerts.toLocaleString()} vértices`;
                    info.style.color = '#27ae60';
                    this.fitCamera();
                } catch (err) {
                    loadingContainer.querySelector('p').textContent = `Error: ${err.message}`;
                    info.textContent = `Error al cargar. Revisa la consola.`;
                    info.style.color = '#e74c3c';
                    console.error(err);
                } finally {
                    fitButton.disabled = !this.currentMesh;
                    repoButton.disabled = false;
                    input.disabled = false;
                }
            }

            fitCamera() {
                if (!this.currentMesh) return;
                const box = new THREE.Box3().setFromObject(this.currentMesh);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = this.camera.fov * (Math.PI / 180);
                let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2)) * 1.5;
                cameraZ = Math.max(cameraZ, 10);

                this.camera.position.set(center.x + cameraZ, center.y + cameraZ, center.z + cameraZ);
                this.controls.target.copy(center);
                this.controls.update();
            }
        };

        window.viewer = viewer;

        fitButton.addEventListener('click', () => viewer.fitCamera());
        repoButton.addEventListener('click', () => viewer.load(REPO_MODEL_URL));

        let currentUrl = null;
        input.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (currentUrl) URL.revokeObjectURL(currentUrl);
            currentUrl = URL.createObjectURL(file);
            await viewer.load(currentUrl);
        });

        // CARGAR AUTOMÁTICAMENTE
        viewer.load(REPO_MODEL_URL);
    });
</script>

</body>
</html>
