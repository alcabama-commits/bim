<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Planos Proyecto Blue - Portal BIM Alcabama</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#D8005E",
            "background-light": "#FFFFFF",
            "background-dark": "#343434",
            "text-light": "#111827",
            "text-dark": "#F3F4F6",
            "card-light": "#FFFFFF",
            "card-dark": "#374151",
            "border-light": "#E5E7EB",
            "border-dark": "#4B5563"
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            'source-sans-pro': ['"Source Sans Pro"', 'sans-serif']
          },
          borderRadius: {
            DEFAULT: "0.5rem",
          },
        },
      },
    };
  </script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
<style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    /* Estilos para el contenedor del visor */
    #viewer-container {
        position: relative;
        width: 100%;
        height: 70vh; /* 70% de la altura de la pantalla */
        min-height: 400px; /* Altura mínima para evitar colapso */
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark">
<div class="relative min-h-screen bg-background-light dark:bg-background-dark">
<header class="absolute top-0 left-0 w-full z-10 px-8 py-4">
    <div class="container mx-auto flex items-center justify-between">
        <div class="flex items-center">
            <a href="home.html" aria-label="Volver a la página de inicio">
                <!-- Logo para modo claro -->
                <img alt="Portal BIM Alcabama Logo" class="h-12 dark:hidden" src="https://i.postimg.cc/wMDNvJB5/Portal-BIM-Alcabama-7-1.png"/>
                <!-- Logo para modo oscuro -->
                <img alt="Portal BIM Alcabama Logo" class="h-12 hidden dark:block" src="https://i.postimg.cc/mgpPTVwf/Portal-BIM-Alcabama-7-2.png"/>
            </a>
        </div>
        <div class="flex items-center space-x-4">
            <button id="theme-toggle" aria-label="Cambiar tema" class="text-text-light dark:text-white hover:text-primary"><span class="material-symbols-outlined">dark_mode</span></button>
            <div id="auth-container" class="flex items-center space-x-4"><a href="inse.html" class="text-text-light dark:text-white hover:text-primary text-sm font-medium">Iniciar sesión</a></div>
        </div>
    </div>
</header>
<main class="pt-24 pb-16">
    <section class="container mx-auto px-8 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">Planos y Modelos del Proyecto Blue</h1>
        <p class="text-center text-gray-600 dark:text-gray-400 max-w-3xl mx-auto mb-6">Modelo cargado desde el repositorio. Usa los botones para interactuar o sube tu propio archivo. Navega en el modelo 3D con el ratón: rueda para zoom, clic derecho para rotar.</p>

        <!-- Controles -->
        <div class="flex justify-center items-center space-x-4 mb-6">
            <button id="fit-button" disabled class="px-4 py-2 bg-primary text-white rounded-md shadow-md hover:bg-opacity-90 transition disabled:bg-gray-400 disabled:cursor-not-allowed">Enfocar Modelo</button>
            <button id="load-repo" class="px-4 py-2 bg-gray-600 text-white rounded-md shadow-md hover:bg-gray-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">Recargar Modelo</button>
        </div>

        <!-- Carga de archivo local -->
        <div class="text-center mb-8">
            <label for="file-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">O sube tu propio archivo .ifc</label>
            <input type="file" id="file-input" accept=".ifc" class="mx-auto block w-full max-w-sm text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer"/>
        </div>

        <!-- Contenedor del Visor -->
        <div id="viewer-container" class="relative rounded-lg shadow-lg overflow-hidden bg-white dark:bg-gray-800">
            <div class="loading absolute inset-0 flex items-center justify-center z-10 bg-white/80 dark:bg-gray-800/80">
                <p class="text-lg font-semibold text-primary">Cargando modelo desde el repositorio...</p>
            </div>
        </div>
        <div class="info text-center mt-4 font-semibold" id="info"></div>

    </section>
</main>
<footer class="bg-background-light dark:bg-background-dark py-8 px-8 mt-auto">
<div class="container mx-auto text-center text-gray-500 dark:text-gray-400">
<!-- Logo para modo claro -->
<img alt="Alcabama logo" class="h-8 mx-auto mb-4 dark:hidden" src="https://i.postimg.cc/GmWLmfZZ/Logo-transparente-negro.png"/>
<!-- Logo para modo oscuro -->
<img alt="Alcabama logo" class="h-8 mx-auto mb-4 hidden dark:block" src="https://i.postimg.cc/0yDgcyBp/Logo-transparente-blanco.png"/>
<p class="text-sm">© 2023 Portal BIM Alcabama - Todos los derechos reservados.</p>
</div>
</footer>
</div>
<!-- Importmap para gestionar las dependencias de Three.js -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    const { IfcAPI } = await import('https://cdn.jsdelivr.net/npm/web-ifc@0.0.51/web-ifc-api.js');

    document.addEventListener('DOMContentLoaded', () => {
        // --- GESTIÓN DE AUTENTICACIÓN Y TEMA ---
        const authContainer = document.getElementById('auth-container');
        const userAccount = JSON.parse(sessionStorage.getItem('userAccount') || localStorage.getItem('userAccount'));

        if (userAccount) {
            authContainer.innerHTML = `
                <span class="text-sm font-medium text-text-light dark:text-white">Hola, ${userAccount.name.split(' ')[0]}</span>
                <button id="logout-button" class="text-text-light dark:text-white hover:text-primary text-sm font-medium">Cerrar sesión</button>
            `;
            document.getElementById('logout-button').addEventListener('click', () => {
                sessionStorage.removeItem('userAccount');
                localStorage.removeItem('userAccount');
                window.location.href = 'home.html';
            });
        }

        const themeToggle = document.getElementById('theme-toggle');
        const htmlEl = document.documentElement;
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                htmlEl.classList.add('dark');
                themeToggle.querySelector('.material-symbols-outlined').textContent = 'light_mode';
            } else {
                htmlEl.classList.remove('dark');
                themeToggle.querySelector('.material-symbols-outlined').textContent = 'dark_mode';
            }
        };
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);
        themeToggle.addEventListener('click', () => {
            const newTheme = htmlEl.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // --- LÓGICA DEL VISOR IFC ---
        const container = document.getElementById('viewer-container');
        const viewer = new IfcViewerAPI({ container, backgroundColor: new THREE.Color(0xeeeeee) });

        viewer.grid.setGrid();
        viewer.axes.setAxes();

        const loadingIndicator = document.getElementById('loading-indicator');

        async function loadIfc(url) {
            try {
                console.log("Iniciando carga del modelo IFC desde:", url);
                loadingIndicator.style.display = 'flex';

                // El motor WASM se carga desde el CDN, usando una versión estable que coincide con la librería local.
                await viewer.IFC.setWasmPath("https://cdn.jsdelivr.net/npm/web-ifc-viewer@1.0.215/wasm/");

                // Carga manual para controlar CORS y asegurar que se obtiene un ArrayBuffer
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error de red: ${response.status} - ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();
                const model = await viewer.IFC.loadIfc(arrayBuffer, true);

                if (model) {
                    loadingIndicator.style.display = 'none';
                    await viewer.shadows.setShadows(model);
                    viewer.context.fitToFrame();
                    console.log("Modelo IFC cargado exitosamente:", model);
                }
            } catch (error) {
                console.error("Error al cargar IFC:", error);
                loadingIndicator.innerHTML = `
                    <div class="text-red-500 text-center p-6 max-w-md mx-auto">
                        <p class="font-bold text-lg">Error al cargar el modelo</p>
                        <p class="text-sm mt-2">${error.message}</p>
                        <p class="text-xs mt-3 text-gray-600 dark:text-gray-400">
                            Asegúrate de que el archivo IFC esté en un servidor con CORS habilitado (como GitHub Pages).
                        </p>
                    </div>`;
            }
        }

        // URL que SÍ permite CORS, usando tu propio repositorio de GitHub Pages
        const ifcUrl = 'https://alcabama-commits.github.io/bim/Models/02_GI_BLU_Estructura_CBombas2.ifc';
        loadIfc(ifcUrl);
    });
</script>
</body></html>
