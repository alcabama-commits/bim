<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor IFC 3D - Torre D</title>
    <link rel="icon" href="data:,">
    <style>
        * { box-sizing: border-box; margin:0; padding:0; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #f4f6f9; 
            color: #2c3e50; 
            padding: 20px; 
            min-height: 100vh; 
        }
        h1 { text-align: center; color: #1a3d7c; font-size: 2em; margin-bottom: 15px; }
        .controls { text-align: center; margin: 15px 0; }
        button { 
            padding: 10px 20px; background: #1a3d7c; color: white; border: none; border-radius: 8px; 
            font-weight: 600; cursor: pointer; margin: 5px; 
        }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        button:hover:not(:disabled) { background: #0d2a5e; }
        .file-upload { text-align: center; margin: 15px 0; }
        .file-upload label { color: #1a3d7c; font-weight: 600; }
        input[type="file"] { 
            padding: 10px; border: 2px dashed #1a3d7c; border-radius: 8px; background: #fff; 
            max-width: 400px; width: 100%; 
        }
        #viewer-container { 
            position: relative; width: 90vw; max-width: 1200px; height: 70vh; min-height: 500px; 
            margin: 30px auto; border: 1px solid #ddd; border-radius: 16px; overflow: hidden; 
            background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
        }
        .loading { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 15px 25px; border-radius: 8px; font-weight: 600; color: #1a3d7c; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        .status { text-align: center; margin: 10px; padding: 10px; background: #eef5ff; border-radius: 8px; max-width: 600px; margin: 10px auto; }
        /* PANEL DEBUG - SIEMPRE VISIBLE */
        .debug { 
            background: #1a3d7c; color: white; padding: 15px; border-radius: 10px; 
            margin: 20px auto; max-width: 900px; font-family: 'Courier New', monospace; 
            font-size: 1em; text-align: left; white-space: pre-wrap; 
            border: 2px solid #0d2a5e; 
        }
        .debug strong { color: #a8d8ff; }
    </style>
</head>
<body>
    <h1>Visor IFC 3D - Torre D</h1>

    <div class="controls">
        <button id="fit-button" disabled>Enfocar Modelo</button>
        <button id="load-repo">Recargar Modelo</button>
    </div>

    <div class="file-upload">
        <label for="file-input">Sube tu archivo .ifc</label>
        <input type="file" id="file-input" accept=".ifc">
    </div>

    <div class="status" id="current-file">Cargando modelo...</div>

    <div id="viewer-container">
        <div class="loading" id="loading">Cargando modelo...</div>
    </div>

    <div id="info" class="status"></div>

    <!-- PANEL DEBUG - SIEMPRE APARECERÁ -->
    <div class="debug" id="debug">
        <strong>DIAGNÓSTICO EN VIVO</strong><br>
        Iniciando visor...
    </div>

    <!-- Importmap -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
    </script>

    <!-- CÓDIGO COMPLETO Y ESTABLE -->
    <script type="module">
        // ELEMENTOS
        const container = document.getElementById('viewer-container');
        const input = document.getElementById('file-input');
        const loadingText = document.getElementById('loading');
        const info = document.getElementById('info');
        const currentFileDiv = document.getElementById('current-file');
        const debug = document.getElementById('debug');
        const fitButton = document.getElementById('fit-button');
        const repoButton = document.getElementById('load-repo');

        // URL DEL MODELO
        const REPO_MODEL_URL = 'https://raw.githubusercontent.com/alcabama-commits/bim/main/Models/02_GI_BLU_Estructura_TorreD.ifc?raw=true';
        const REPO_MODEL_NAME = '02_GI_BLU_Estructura_TorreD.ifc';

        // ACTUALIZAR DEBUG
        const log = (msg) => {
            debug.innerHTML += msg + '<br>';
            console.log('[IFC]', msg);
        };

        log('Importando librerías...');

        try {
            // IMPORTAR THREE Y CONTROLES
            const THREE = await import('three');
            const { OrbitControls } = await import('three/addons/controls/OrbitControls.js');
            const { IfcAPI } = await import('https://cdn.jsdelivr.net/npm/web-ifc@0.0.51/web-ifc-api.js');

            log('Three.js y web-ifc cargados');

            // VISOR
            const viewer = new class {
                constructor() {
                    log('Inicializando escena 3D...');
                    this.scene = new THREE.Scene();
                    this.scene.background = new THREE.Color(0xf5f7fa);
                    this.camera = new THREE.PerspectiveCamera(75, container.clientWidth/container.clientHeight, 0.1, 1000);
                    this.camera.position.set(50, 50, 50);
                    this.renderer = new THREE.WebGLRenderer({ antialias: true });
                    this.renderer.setSize(container.clientWidth, container.clientHeight);
                    this.renderer.setPixelRatio(window.devicePixelRatio);
                    container.appendChild(this.renderer.domElement);

                    this.scene.add(new THREE.AmbientLight(0xffffff, 0.6));
                    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    dirLight.position.set(100, 100, 100);
                    this.scene.add(dirLight);

                    this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                    this.controls.enableDamping = true;

                    this.scene.add(new THREE.GridHelper(200, 50));
                    this.scene.add(new THREE.AxesHelper(50));

                    this.ifc = new IfcAPI();
                    this.ifc.SetWasmPath('https://cdn.jsdelivr.net/npm/web-ifc@0.0.51/');

                    this.models = [];
                    this.currentMesh = null;

                    const animate = () => {
                        requestAnimationFrame(animate);
                        this.controls.update();
                        this.renderer.render(this.scene, this.camera);
                    };
                    animate();

                    window.addEventListener('resize', () => {
                        this.camera.aspect = container.clientWidth / container.clientHeight;
                        this.camera.updateProjectionMatrix();
                        this.renderer.setSize(container.clientWidth, container.clientHeight);
                    });
                }

                async load(url, name) {
                    log(`Descargando: ${name}`);
                    currentFileDiv.textContent = `Cargando: ${name}...`;
                    loadingText.style.display = 'block';
                    fitButton.disabled = true;

                    this.models.forEach(m => this.scene.remove(m));
                    this.models = [];

                    try {
                        await this.ifc.Init();
                        log('web-ifc inicializado');

                        const res = await fetch(url);
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const buffer = await res.arrayBuffer();
                        log(`Descargado: ${(buffer.byteLength/1024/1024).toFixed(2)} MB`);

                        const modelID = this.ifc.OpenModel(new Uint8Array(buffer), { COORDINATE_TO_ORIGIN: true });
                        log(`Modelo abierto (ID: ${modelID})`);

                        const types = this.ifc.GetAllTypes(modelID);
                        log(`Tipos IFC: ${types.length}`);

                        let verts = 0;
                        const pos = [], idx = [];

                        for (const type of types) {
                            const ids = this.ifc.GetLineIDsWithType(modelID, type);
                            for (let i = 0; i < ids.size(); i++) {
                                const geom = this.ifc.GetGeometry(modelID, ids.get(i));
                                if (!geom) continue;
                                const v = geom.GetVertexData();
                                const ind = geom.GetIndexData();
                                const base = pos.length / 3;
                                for (let j = 0; j < v.length; j += 3) pos.push(v[j], v[j+1], v[j+2]);
                                for (let j = 0; j < ind.length; j++) idx.push(ind[j] + base);
                                verts += v.length / 3;
                            }
                        }

                        if (verts === 0) throw new Error('No hay geometría 3D');

                        log(`ÉXITO: ${verts.toLocaleString()} vértices`);

                        const geo = new THREE.BufferGeometry();
                        geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
                        geo.setIndex(idx);
                        geo.computeVertexNormals();

                        const mat = new THREE.MeshLambertMaterial({ color: 0x6699ff, side: THREE.DoubleSide });
                        const mesh = new THREE.Mesh(geo, mat);
                        this.scene.add(mesh);
                        this.models.push(mesh);
                        this.currentMesh = mesh;

                        loadingText.style.display = 'none';
                        info.textContent = `Cargado: ${verts.toLocaleString()} vértices`;
                        info.style.color = '#27ae60';
                        currentFileDiv.textContent = `Listo: ${name}`;
                        currentFileDiv.style.color = '#27ae60';
                        this.fitCamera();
                    } catch (err) {
                        loadingText.style.display = 'none';
                        info.textContent = `Error: ${err.message}`;
                        info.style.color = '#e74c3c';
                        log(`ERROR: ${err.message}`);
                    } finally {
                        fitButton.disabled = false;
                    }
                }

                fitCamera() {
                    if (!this.currentMesh) return;
                    const box = new THREE.Box3().setFromObject(this.currentMesh);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    const max = Math.max(size.x, size.y, size.z);
                    const dist = Math.max(max * 1.5, 50);
                    this.camera.position.copy(center).add(new THREE.Vector3(dist, dist, dist));
                    this.controls.target.copy(center);
                    this.controls.update();
                }
            };

            // INICIAR
            const v = new viewer();
            fitButton.onclick = () => v.fitCamera();
            repoButton.onclick = () => v.load(REPO_MODEL_URL, REPO_MODEL_NAME);
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) v.load(URL.createObjectURL(file), file.name);
            };

            // CARGAR AL INICIO
            v.load(REPO_MODEL_URL, REPO_MODEL_NAME);

        } catch (err) {
            log(`FALLO CRÍTICO: ${err.message}`);
            console.error(err);
        }
    </script>
</body>
</html>
