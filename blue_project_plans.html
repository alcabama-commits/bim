<script type="module">
import * as THREE from './libs/three.module.js';
// ✅ Se usa la versión oficial del visor desde CDN (compatible y estable)
import { IfcViewerAPI } from "https://cdn.jsdelivr.net/npm/web-ifc-viewer@1.0.215/dist/web-ifc-viewer.es.js";

document.addEventListener('DOMContentLoaded', () => {
  // --- GESTIÓN DE AUTENTICACIÓN Y TEMA ---
  const authContainer = document.getElementById('auth-container');
  const userAccount = JSON.parse(sessionStorage.getItem('userAccount') || localStorage.getItem('userAccount'));

  if (userAccount) {
    authContainer.innerHTML = `
      <span class="text-sm font-medium text-text-light dark:text-white">Hola, ${userAccount.name.split(' ')[0]}</span>
      <button id="logout-button" class="text-text-light dark:text-white hover:text-primary text-sm font-medium">Cerrar sesión</button>
    `;
    document.getElementById('logout-button').addEventListener('click', () => {
      sessionStorage.removeItem('userAccount');
      localStorage.removeItem('userAccount');
      window.location.href = 'home.html';
    });
  }

  // --- GESTIÓN DE TEMA (oscuro / claro) ---
  const themeToggle = document.getElementById('theme-toggle');
  const htmlEl = document.documentElement;

  const applyTheme = (theme) => {
    if (theme === 'dark') {
      htmlEl.classList.add('dark');
      themeToggle.querySelector('.material-symbols-outlined').textContent = 'light_mode';
    } else {
      htmlEl.classList.remove('dark');
      themeToggle.querySelector('.material-symbols-outlined').textContent = 'dark_mode';
    }
  };

  const savedTheme = localStorage.getItem('theme') ||
    (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  applyTheme(savedTheme);

  themeToggle.addEventListener('click', () => {
    const newTheme = htmlEl.classList.contains('dark') ? 'light' : 'dark';
    localStorage.setItem('theme', newTheme);
    applyTheme(newTheme);
  });

  // --- LÓGICA DEL VISOR IFC ---
  const container = document.getElementById('viewer-container');
  const viewer = new IfcViewerAPI({ container, backgroundColor: new THREE.Color(0xeeeeee) });

  viewer.grid.setGrid();
  viewer.axes.setAxes();

  const loadingIndicator = document.getElementById('loading-indicator');

  async function loadIfc(url) {
    try {
      console.log("Iniciando carga del modelo IFC desde:", url);
      loadingIndicator.style.display = 'flex';

      // Cargar WASM del visor
      await viewer.IFC.setWasmPath("https://cdn.jsdelivr.net/npm/web-ifc-viewer@1.0.215/wasm/");

      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Error de red: ${response.status} - ${response.statusText}`);
      }

      const arrayBuffer = await response.arrayBuffer();
      const model = await viewer.IFC.loadIfc(arrayBuffer, true);

      if (model) {
        loadingIndicator.style.display = 'none';
        await viewer.shadows.setShadows(model);
        viewer.context.fitToFrame();
        console.log("✅ Modelo IFC cargado exitosamente:", model);
      }
    } catch (error) {
      console.error("❌ Error al cargar IFC:", error);
      loadingIndicator.innerHTML = `
        <div class="text-red-500 text-center p-6 max-w-md mx-auto">
          <p class="font-bold text-lg">Error al cargar el modelo</p>
          <p class="text-sm mt-2">${error.message}</p>
          <p class="text-xs mt-3 text-gray-600 dark:text-gray-400">
            Asegúrate de que el archivo IFC esté en un servidor con CORS habilitado (como GitHub Pages).
          </p>
        </div>
      `;
    }
  }

  // ✅ URL de tu modelo (GitHub Pages con CORS)
  const ifcUrl = 'https://alcabama-commits.github.io/bim/Models/02_GI_BLU_Estructura_CBombas2.ifc';
  loadIfc(ifcUrl);
});
</script>
