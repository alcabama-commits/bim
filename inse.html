<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Iniciar Sesión - Portal BIM Alcabama</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#D8005A",
                        "background-light": "#F3F4F6",
                        "background-dark": "#111827",
                        "text-light": "#1F2937",
                        "text-dark": "#F9FAFB"
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                },
            },
        };
    </script>
    <!-- MSAL.js para autenticación con Azure AD -->
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">

    <div class="min-h-screen flex flex-col items-center justify-center">
        <div class="text-center mb-8">
            <img alt="Alcabama logo" class="h-12 mx-auto mb-4" src="https://i.postimg.cc/yN3gwWn5/logo-bim-ajustado.png"/>
            <h1 class="text-2xl font-bold">Portal BIM Alcabama</h1>
            <p class="text-gray-500 dark:text-gray-400">Inicia sesión para continuar</p>
        </div>

        <div class="w-full max-w-sm p-8 bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <button id="login-button" class="w-full flex items-center justify-center bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 transition duration-300">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21.4,5.3h-3.1V2.2h-3.1v3.1H12V2.2H8.9v3.1H5.8v3.1H2.7v3.1H5.8v3.1H8.9v3.1H12v-3.1h3.1v-3.1h3.1V8.4h3.1V5.3H21.4z M15.3,12.5h-3.1v3.1H8.9v-3.1H5.8V8.4h3.1V5.3h3.1v3.1h3.1V12.5z"/>
                </svg>
                Iniciar sesión con Microsoft
            </button>
            <div id="error-message" class="mt-4 text-red-500 text-sm text-center"></div>
        </div>
        <a href="https://alcabama-commits.github.io/bim/home" class="mt-6 text-sm text-primary hover:underline">Volver a la página principal</a>
    </div>

    <script>
        // --- CONFIGURACIÓN DE AUTENTICACIÓN MSAL ---
        const msalConfig = {
            auth: {
                // Reemplaza con los datos de tu aplicación en Azure AD
                clientId: "8dc59d32-a4cd-48df-9d65-f19b53f36f28", 
                authority: "https://login.microsoftonline.com/common", // Volvemos a 'common' para permitir MSA
                redirectUri: window.location.origin + window.location.pathname, // URI de redirección en Azure (la URL actual de la página)
            },
            cache: {
                cacheLocation: "sessionStorage", // Usa sessionStorage para que la sesión se cierre al cerrar la pestaña
                storeAuthStateInCookie: false,
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // --- LÓGICA DE INICIO DE SESIÓN ---
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');

        loginButton.addEventListener('click', async () => {
            try {
                await msalInstance.loginPopup({
                    scopes: ["User.Read", "GroupMember.Read.All"] // Quitamos permisos de SharePoint
                });

                const account = msalInstance.getAllAccounts()[0];
                console.log('MSAL Account after loginPopup:', account); // Debugging: Verificar si se obtiene la cuenta

                if (account) {
                    let groupNames = null; // Inicia como null para indicar que no se han obtenido los grupos
                    
                    // Intenta obtener los grupos del usuario. Si falla, no interrumpe el login.
                    try {
                        const accessTokenRequest = {
                            scopes: ["User.Read", "GroupMember.Read.All"], // Pedir explícitamente los scopes para Graph
                            account: account
                        };
                        const response = await msalInstance.acquireTokenSilent(accessTokenRequest);
                        
                        const groupsResponse = await fetch("https://graph.microsoft.com/v1.0/me/memberOf", {
                            headers: { "Authorization": `Bearer ${response.accessToken}` }
                        });
                        
                        if (groupsResponse.ok) {
                            const groupsData = await groupsResponse.json();
                            // Filtramos para asegurarnos de que solo obtenemos objetos con displayName
                            groupNames = groupsData.value.filter(g => g.displayName).map(g => g.displayName);
                        } else if (groupsResponse.status === 403) {
                            console.error("Error 403: Permisos insuficientes. Falta el consentimiento de administrador para 'GroupMember.Read.All'.");
                            errorMessage.textContent = "Error de permisos (403). Contacta al administrador.";
                        } else {
                            const errorText = await groupsResponse.text();
                            console.error(`Error al obtener grupos: ${groupsResponse.status} - ${groupsResponse.statusText}`);
                            console.error("Respuesta de la API de Graph:", errorText);
                            errorMessage.textContent = `Error al obtener roles (${groupsResponse.status}).`;
                        }
                    } catch (groupError) {
                        console.error("Excepción al obtener los grupos. Revisa la configuración de la app y los permisos de API.", groupError);
                        // Si es un error de interacción, MSAL lo manejará en el catch principal.
                        if (!(groupError instanceof msal.InteractionRequiredAuthError)) {
                            errorMessage.textContent = "Error técnico al obtener roles. Revisa la consola.";
                        }
                    }
                    
                    const userProfile = {
                        name: account.name,
                        username: account.username,
                        groups: groupNames // Se guardará el array de grupos o null si falló
                    };                    
                    console.log('DEBUG: Grupos obtenidos para el usuario:', groupNames); // <-- AÑADIDO PARA DEPURACIÓN

                    sessionStorage.setItem('userAccount', JSON.stringify(userProfile));

                    window.location.href = 'https://alcabama-commits.github.io/bim/home'; // Redirigir
                }
            } catch (error) {
                console.error(error);
                errorMessage.textContent = "Error al iniciar sesión. Por favor, inténtalo de nuevo.";
            }
        });

        // --- GESTIÓN DEL TEMA (MODO OSCURO/CLARO) ---
        // Para mantener consistencia visual si el usuario navega aquí
        document.addEventListener('DOMContentLoaded', () => {
            const htmlEl = document.documentElement;
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    htmlEl.classList.add('dark');
                } else {
                    htmlEl.classList.remove('dark');
                }
            };
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        });
    </script>
</body>
</html>
