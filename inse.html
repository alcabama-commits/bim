<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Iniciar Sesión - Portal BIM Alcabama</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#D8005A",
                        "background-light": "#F3F4F6",
                        "background-dark": "#111827",
                        "text-light": "#1F2937",
                        "text-dark": "#F9FAFB"
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                },
            },
        };
    </script>
    <!-- MSAL.js para autenticación con Azure AD -->
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">

    <div class="min-h-screen flex flex-col items-center justify-center">
        <div class="text-center mb-8">
            <img alt="Alcabama logo" class="h-12 mx-auto mb-4" src="https://i.postimg.cc/yN3gwWn5/logo-bim-ajustado.png"/>
            <h1 class="text-2xl font-bold">Portal BIM Alcabama</h1>
            <p class="text-gray-500 dark:text-gray-400">Inicia sesión para continuar</p>
        </div>

        <div class="w-full max-w-sm p-8 bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="mb-6">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="keep-signed-in" class="form-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary">
                    <span class="ml-3 text-sm text-gray-600 dark:text-gray-300">Mantener la sesión iniciada</span>
                </label>
            </div>
            <button id="login-button" class="w-full flex items-center justify-center bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 transition duration-300">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21.4,5.3h-3.1V2.2h-3.1v3.1H12V2.2H8.9v3.1H5.8v3.1H2.7v3.1H5.8v3.1H8.9v3.1H12v-3.1h3.1v-3.1h3.1V8.4h3.1V5.3H21.4z M15.3,12.5h-3.1v3.1H8.9v-3.1H5.8V8.4h3.1V5.3h3.1v3.1h3.1V12.5z"/>
                </svg>
                Iniciar sesión con Microsoft
            </button>
            <div id="error-message" class="mt-4 text-red-500 text-sm text-center"></div>
        </div>
        <a href="https://alcabama-commits.github.io/bim/home.html" class="mt-6 text-sm text-primary hover:underline">Volver a la página principal</a>
    </div>

    <script>
        // --- CONFIGURACIÓN DE AUTENTICACIÓN MSAL ---
        // --- LÓGICA DE INICIO DE SESIÓN ---
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const keepSignedInCheckbox = document.getElementById('keep-signed-in');

        loginButton.addEventListener('click', async () => {
            try {
                const cacheLocation = keepSignedInCheckbox.checked ? "localStorage" : "sessionStorage";
                console.log(`Using cache location: ${cacheLocation}`);

                const msalConfig = {
                    auth: {
                        clientId: "8dc59d32-a4cd-48df-9d65-f19b53f36f28", 
                        authority: "https://login.microsoftonline.com/common",
                        redirectUri: window.location.href,
                    },
                    cache: {
                        cacheLocation: cacheLocation,
                        storeAuthStateInCookie: false,
                    }
                };

                const msalInstance = new msal.PublicClientApplication(msalConfig);

                await msalInstance.loginPopup({
                    scopes: ["User.Read"] // Solo necesitamos leer el perfil del usuario
                });

                const account = msalInstance.getAllAccounts()[0];
                console.log('MSAL Account after loginPopup:', account); // Debugging: Verificar si se obtiene la cuenta

                if (account) {
                    // URL del script que devuelve la lista de roles en formato JSON
                    const ROLES_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw3LZBukOETESOjCrz1EdEcYVHry5_S_SzHGyPvKUm2JHr2Roppt36m2jsijYVI74s/exec';
                    let userRole = null;

                    try {
                        const response = await fetch(ROLES_SCRIPT_URL);
                        const rolesList = await response.json();
                        const userData = rolesList.find(u => u.email.toLowerCase() === account.username.toLowerCase());
                        if (userData) {
                            userRole = userData.rol; // 'rol' en minúsculas, como lo devuelve el script
                        }
                    } catch (error) {
                        console.error("Error al obtener la lista de roles:", error);
                    }

                    const userProfile = {
                        name: account.name,
                        username: account.username,
                        role: userRole // Guardamos el rol del usuario
                    };                    
                    console.log('DEBUG: User profile created:', userProfile);

                    // Guardar en localStorage si se marcó "Mantener sesión", si no, en sessionStorage
                    if (keepSignedInCheckbox.checked) {
                        localStorage.setItem('userAccount', JSON.stringify(userProfile));
                    } else {
                        sessionStorage.setItem('userAccount', JSON.stringify(userProfile));
                    }

                    window.location.href = 'https://alcabama-commits.github.io/bim/home.html'; // Redirigir a la página de inicio correcta
                }
            } catch (error) {
                console.error(error);
                errorMessage.textContent = "Error al iniciar sesión. Por favor, inténtalo de nuevo.";
            }
        });

        // --- GESTIÓN DEL TEMA (MODO OSCURO/CLARO) ---
        // Para mantener consistencia visual si el usuario navega aquí
        document.addEventListener('DOMContentLoaded', () => {
            const htmlEl = document.documentElement;
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    htmlEl.classList.add('dark');
                } else {
                    htmlEl.classList.remove('dark');
                }
            };
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        });
    </script>
</body>
</html>
