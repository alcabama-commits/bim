<!DOCTYPE html>
<html lang="es"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Formulario de ingreso de usuarios - BIM Alcazarma</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#374151",
              "background-light": "#FFFFFF",
              "background-dark": "#111827",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
            },
          },
        },
      };
    </script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        // --- SCRIPT DE SEGURIDAD ---
        (function() {
            // Buscar usuario en sessionStorage y luego en localStorage
            const userAccount = JSON.parse(sessionStorage.getItem('userAccount') || localStorage.getItem('userAccount'));

            // 1. Si no hay usuario, redirigir al login.
            if (!userAccount) {
                alert('Acceso denegado. Por favor, inicie sesión.');
                window.location.href = 'https://alcabama-commits.github.io/bim/inse.html';
                return;
            }

            // 2. Lógica de seguridad: Denegar acceso si el rol no es 'ADMINISTRADOR'.
            const allowedRoles = ['ADMINISTRADOR'];
            const userRole = userAccount.role;
            const isAllowed = userRole && allowedRoles.includes(userRole);

            if (!isAllowed) {
                alert('Acceso denegado. No tiene permisos para ver esta página.');
                window.location.href = 'https://alcabama-commits.github.io/bim/home.html';
            }
        })();
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark text-gray-900 dark:text-gray-100">
<div class="flex flex-col min-h-screen">
<header class="py-6 px-4 sm:px-6 lg:px-8">
<div class="flex items-center space-x-4">
<img alt="BIM Logo" class="h-10 w-auto" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCrmYsDxOkD_ioE_I3x-UxFh3dPRE3Ze6h07IcBC0o8k83W9i8CvT4m0l7lYQrkblksjE6b_GTJl0Y4Zq9e77x0OgF3v5ZQrqqzQ3Khb6GEGEsgqgMfxyf2BGpKh42XdLnWUkJxJi2eVWIkNDWPjGdNeqIL2KjCVnTmfPReKR1NbuMH_VNqCl9Ewi0TCyqBNupy4Nwt06DqMA-A5Q0NNOryqfKAnqL21ZSYeO3JmPs0JBMYH1-LhlQg0KcK7LaF2XycmvVbUTPOnH86"/>
<span class="border-l border-gray-300 dark:border-gray-600 h-10"></span>
<h1 class="text-xl text-gray-600 dark:text-gray-300">Formulario de ingreso de usuarios</h1>
</div>
</header>
<main class="flex-grow flex items-center">
<div class="container mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex flex-col md:flex-row items-stretch overflow-hidden rounded-lg shadow-lg bg-white dark:bg-gray-800">
<div class="w-full md:w-1/2 p-8">
<form class="space-y-6">
<div>
<label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="usuario">Usuario</label>
<input class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary bg-background-light dark:bg-gray-700 text-gray-900 dark:text-gray-100" id="usuario" name="usuario" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="correo">Correo</label>
<input class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary bg-background-light dark:bg-gray-700 text-gray-900 dark:text-gray-100" id="correo" name="correo" type="email"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="empresa">Empresa</label>
<input class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary bg-background-light dark:bg-gray-700 text-gray-900 dark:text-gray-100" id="empresa" name="empresa" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="rol">Rol</label>
<select class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary bg-background-light dark:bg-gray-700 text-gray-900 dark:text-gray-100" id="rol" name="rol">
<option value="ADMINISTRADOR">ADMINISTRADOR</option>
<option value="EDGE">EDGE</option>
<option value="COMBOS Y REFORMAS">COMBOS Y REFORMAS</option>
<option value="ACÚSTICA">ACÚSTICA</option>
<option value="ARQUITECTURA">ARQUITECTURA</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="especialidad">Especialidad</label>
<input class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring-primary bg-background-light dark:bg-gray-700 text-gray-900 dark:text-gray-100" id="especialidad" name="especialidad" type="text"/>
</div>
<div class="pt-4">
<button class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" type="submit">Guardar Rol</button>
</div>
</form>
</div>
<div class="hidden md:block w-1/2">
<img alt="Recepción de oficina moderna con personas" class="w-full h-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCAgXjgNm6Gs6wrvifkTKdcjqvgbOgzzIcWpRK36ek401-KJJ2vBgH4Sd36eQ5lowIrTLvMQUzGK14uPfFHXXT24kwXC36HeB9f37Kljd2SWf_ZXEBGOysmRj6kzpKUvYXF2EAQ5xBOC3VdlLBBZJuYu_xHjkvknCHyQpozH6AQSEVLgxcPvJYc7jcl0hWEXE9GhPAiKcN9c4WeYMP2QucjZ8ZNNS3YH8mbb8pH8qsplWRr3owCcUHi-E_vGOkk76hhRsJKxjep-_HO"/>
</div>
</div>
</div>
</main>
<footer class="py-6 px-4 sm:px-6 lg:px-8">
<div class="flex flex-col items-center justify-center">
<img alt="BIM Logo" class="h-8 w-auto mb-2" src="https://lh3.googleusercontent.com/aida-public/AB6AXuC10fbJsD0jw-5YVCyeMclFCqYFvn0KQfHdVXrFmRIvgwJPtdZtQI_8uSX0b8SS6sWjJPvHBOmrKfh7_B3CYMLFpbl-qPZJ3F23JucNvLsfOpEvOrAECEl7-2Kcx29CyCUP1dCrq3UktLxmLcY3ER8lspgLT6DKE8rAu-zX1ZVHQBqQzrJBoe5ro5gpD0sBs26N7E5_0_rQ-ycMk6Av4Cq-gnQCuzaJTaKhBEhyDiIuC6aCS51g_dW9DHo8xLITfIyD-kS1JzkJYOCr"/>
<p class="text-xs text-gray-500 dark:text-gray-400">© 2025 Portal BIM Alcazarma. Todos los derechos reservados.</p>
</div>
</footer>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('form');
        const submitButton = form.querySelector('button[type="submit"]');
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw3LZBukOETESOjCrz1EdEcYVHry5_S_SzHGyPvKUm2JHr2Roppt36m2jsijYVI74s/exec';

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = 'Guardando...';

            const data = {
                email: document.getElementById('correo').value,
                rol: document.getElementById('rol').value,
                // Campos adicionales que coinciden con las columnas del Google Sheet
                nombre: document.getElementById('usuario').value,
                empresa: document.getElementById('empresa').value,
                especialidad: document.getElementById('especialidad').value
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    body: JSON.stringify(data)
                });

                // No se procesa la respuesta para evitar errores de CORS con el modo 'no-cors'
                // que a veces es necesario con Apps Script.
                // Se asume éxito si no hay un error de red.
                alert('Rol guardado con éxito. La actualización puede tardar unos momentos en reflejarse.');
                form.reset();

            } catch (error) {
                console.error('Error al enviar el formulario:', error);
                alert(`Error: ${error.message}. Asegúrate de que la URL del script sea correcta y esté implementada para acceso anónimo.`);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });

        // Lógica para pre-rellenar el formulario para edición
        const params = new URLSearchParams(window.location.search);
        const emailToEdit = params.get('email');

        if (emailToEdit) {
            submitButton.innerHTML = 'Actualizando...';
            submitButton.disabled = true;

            // Fetch all users to find the one to edit
            fetch(SCRIPT_URL)
                .then(res => res.json())
                .then(users => {
                    const userToEdit = users.find(user => user.email.toLowerCase() === emailToEdit.toLowerCase());
                    if (userToEdit) {
                        document.getElementById('usuario').value = userToEdit.nombre || '';
                        document.getElementById('correo').value = userToEdit.email || '';
                        document.getElementById('correo').readOnly = true; // El correo no se debe poder editar
                        document.getElementById('correo').classList.add('bg-gray-200', 'dark:bg-gray-600');
                        document.getElementById('empresa').value = userToEdit.empresa || '';
                        document.getElementById('rol').value = userToEdit.rol || '';
                        document.getElementById('especialidad').value = userToEdit.especialidad || '';
                        
                        submitButton.innerHTML = 'Actualizar Usuario';
                        submitButton.disabled = false;
                    } else {
                        alert('Usuario no encontrado.');
                        submitButton.innerHTML = 'Guardar Rol';
                        submitButton.disabled = false;
                    }
                })
                .catch(err => {
                    console.error('Error al cargar datos del usuario:', err);
                    alert('No se pudieron cargar los datos para editar.');
                    submitButton.innerHTML = 'Guardar Rol';
                    submitButton.disabled = false;
                });
        }
    });
</script>
</body></html>
